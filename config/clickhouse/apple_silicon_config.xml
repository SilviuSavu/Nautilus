<?xml version="1.0"?>
<!-- ClickHouse Apple Silicon M4 Max Optimization Configuration -->
<!-- Optimized for 36GB unified memory, 12 P-cores + 4 E-cores, 40-core GPU -->

<clickhouse>
    <!-- Memory Configuration for M4 Max 36GB -->
    <max_memory_usage>12000000000</max_memory_usage> <!-- 12GB limit -->
    <max_server_memory_usage>16000000000</max_server_memory_usage> <!-- 16GB server limit -->
    
    <!-- Cache Configuration -->
    <uncompressed_cache_size>3221225472</uncompressed_cache_size> <!-- 3GB uncompressed cache -->
    <mark_cache_size>2147483648</mark_cache_size> <!-- 2GB mark cache -->
    <compiled_expression_cache_size>134217728</compiled_expression_cache_size> <!-- 128MB expression cache -->
    <query_cache_size_in_bytes>1073741824</query_cache_size_in_bytes> <!-- 1GB query cache -->
    
    <!-- CPU Configuration for M4 Max -->
    <max_threads>12</max_threads> <!-- Use all 12 P-cores -->
    <background_pool_size>16</background_pool_size> <!-- Background operations -->
    <background_merges_mutations_concurrency_ratio>2</background_merges_mutations_concurrency_ratio>
    <max_concurrent_queries>100</max_concurrent_queries>
    
    <!-- Apple Silicon Specific Optimizations -->
    <profiles>
        <default>
            <!-- Memory settings for unified memory architecture -->
            <max_memory_usage>6000000000</max_memory_usage> <!-- 6GB per query -->
            <memory_overcommit_ratio_denominator>1</memory_overcommit_ratio_denominator>
            
            <!-- CPU settings for M4 Max architecture -->
            <max_threads>12</max_threads>
            <max_execution_time>3600</max_execution_time>
            <timeout_before_checking_execution_speed>60</timeout_before_checking_execution_speed>
            
            <!-- Parallel processing optimizations -->
            <max_parallel_replicas>4</max_parallel_replicas>
            <parallel_replicas_count>4</parallel_replicas_count>
            <parallel_replica_offset>0</parallel_replica_offset>
            
            <!-- Join optimizations for large datasets -->
            <max_bytes_in_join>2147483648</max_bytes_in_join> <!-- 2GB join limit -->
            <join_use_nulls>1</join_use_nulls>
            <join_algorithm>hash</join_algorithm>
            
            <!-- Aggregation optimizations -->
            <max_bytes_before_external_group_by>1073741824</max_bytes_before_external_group_by> <!-- 1GB -->
            <max_bytes_before_external_sort>2147483648</max_bytes_before_external_sort> <!-- 2GB -->
            
            <!-- Network and I/O optimizations -->
            <max_network_bandwidth>1000000000</max_network_bandwidth> <!-- 1GB/s -->
            <max_network_bytes>1073741824</max_network_bytes> <!-- 1GB -->
            
            <!-- Query complexity limits -->
            <max_ast_depth>1000</max_ast_depth>
            <max_ast_elements>50000</max_ast_elements>
            <max_expanded_ast_elements>500000</max_expanded_ast_elements>
            
            <!-- Result limits -->
            <max_result_rows>1000000</max_result_rows>
            <max_result_bytes>1073741824</max_result_bytes> <!-- 1GB -->
            
            <!-- Trading-specific optimizations -->
            <allow_experimental_analyzer>1</allow_experimental_analyzer>
            <enable_optimize_predicate_expression>1</enable_optimize_predicate_expression>
            <optimize_move_to_prewhere>1</optimize_move_to_prewhere>
            <optimize_read_in_order>1</optimize_read_in_order>
        </default>
        
        <!-- High-performance profile for trading analytics -->
        <trading_analytics>
            <max_memory_usage>10000000000</max_memory_usage> <!-- 10GB for complex analytics -->
            <max_threads>16</max_threads> <!-- Use all available cores -->
            <max_execution_time>7200</max_execution_time> <!-- 2 hours for complex queries -->
            
            <!-- Optimizations for time-series data -->
            <optimize_aggregation_in_order>1</optimize_aggregation_in_order>
            <optimize_read_in_order>1</optimize_read_in_order>
            <optimize_move_to_prewhere>1</optimize_move_to_prewhere>
            
            <!-- Enhanced join performance -->
            <max_bytes_in_join>4294967296</max_bytes_in_join> <!-- 4GB join limit -->
            <join_algorithm>parallel_hash</join_algorithm>
            
            <!-- Parallel processing for analytics -->
            <max_parallel_replicas>8</max_parallel_replicas>
            <parallel_replicas_count>8</parallel_replicas_count>
        </trading_analytics>
        
        <!-- Real-time profile for low-latency queries -->
        <realtime>
            <max_memory_usage>2000000000</max_memory_usage> <!-- 2GB for real-time queries -->
            <max_threads>4</max_threads> <!-- Limited threads for low latency -->
            <max_execution_time>30</max_execution_time> <!-- 30 seconds max -->
            
            <!-- Optimizations for real-time performance -->
            <prefer_localhost_replica>1</prefer_localhost_replica>
            <compile_expressions>1</compile_expressions>
            <min_count_to_compile_expression>1</min_count_to_compile_expression>
            
            <!-- Cache optimizations -->
            <use_uncompressed_cache>1</use_uncompressed_cache>
            <use_skip_indexes>1</use_skip_indexes>
        </realtime>
    </profiles>
    
    <!-- Users configuration -->
    <users>
        <nautilus>
            <password>nautilus123</password>
            <profile>trading_analytics</profile>
            <quota>default</quota>
            <allow_databases>
                <database>nautilus</database>
                <database>system</database>
            </allow_databases>
            <access_management>1</access_management>
        </nautilus>
        
        <realtime_user>
            <password>nautilus123</password>
            <profile>realtime</profile>
            <quota>realtime</quota>
            <allow_databases>
                <database>nautilus</database>
            </allow_databases>
        </realtime_user>
    </users>
    
    <!-- Quotas for different workloads -->
    <quotas>
        <default>
            <interval>
                <duration>3600</duration>
                <queries>1000</queries>
                <errors>100</errors>
                <result_rows>1000000000</result_rows>
                <read_rows>1000000000</read_rows>
                <execution_time>3600</execution_time>
            </interval>
        </default>
        
        <realtime>
            <interval>
                <duration>3600</duration>
                <queries>10000</queries>
                <errors>10</errors>
                <result_rows>100000000</result_rows>
                <read_rows>100000000</read_rows>
                <execution_time>1800</execution_time>
            </interval>
        </realtime>
    </quotas>
    
    <!-- Logging configuration -->
    <logger>
        <level>information</level>
        <log>/var/log/clickhouse-server/clickhouse-server.log</log>
        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>
        <size>1000M</size>
        <count>10</count>
    </logger>
    
    <!-- Network configuration -->
    <listen_host>0.0.0.0</listen_host>
    <http_port>8123</http_port>
    <tcp_port>9000</tcp_port>
    <https_port>9440</https_port>
    
    <!-- Storage configuration optimized for Apple Silicon -->
    <storage_configuration>
        <disks>
            <default>
                <path>/var/lib/clickhouse/</path>
            </default>
            
            <!-- Apple Silicon optimized disk for hot data -->
            <hot_disk>
                <type>local</type>
                <path>/var/lib/clickhouse/hot/</path>
                <!-- Optimize for M4 Max SSD performance -->
                <max_free_space>100GiB</max_free_space>
            </hot_disk>
            
            <!-- Cold storage for historical data -->
            <cold_disk>
                <type>local</type>
                <path>/var/lib/clickhouse/cold/</path>
                <max_free_space>500GiB</max_free_space>
            </cold_disk>
        </disks>
        
        <policies>
            <hot_cold_policy>
                <volumes>
                    <hot>
                        <disk>hot_disk</disk>
                        <!-- Move to cold after 7 days -->
                        <max_data_part_size_bytes>0</max_data_part_size_bytes>
                        <move_factor>0.1</move_factor>
                    </hot>
                    <cold>
                        <disk>cold_disk</disk>
                    </cold>
                </volumes>
            </hot_cold_policy>
        </policies>
    </storage_configuration>
    
    <!-- Merge tree configuration for trading data -->
    <merge_tree>
        <!-- Optimize for M4 Max performance -->
        <max_suspicious_broken_parts>10</max_suspicious_broken_parts>
        <parts_to_delay_insert>150</parts_to_delay_insert>
        <parts_to_throw_insert>300</parts_to_throw_insert>
        <max_delay_to_insert>1</max_delay_to_insert>
        
        <!-- Memory optimizations -->
        <max_bytes_to_merge_at_max_space_in_pool>2147483648</max_bytes_to_merge_at_max_space_in_pool> <!-- 2GB -->
        <max_bytes_to_merge_at_min_space_in_pool>1048576</max_bytes_to_merge_at_min_space_in_pool> <!-- 1MB -->
        
        <!-- Apple Silicon specific optimizations -->
        <merge_max_block_size>8192</merge_max_block_size>
        <max_part_loading_threads>8</max_part_loading_threads>
        <max_part_removal_threads>8</max_part_removal_threads>
    </merge_tree>
    
    <!-- Distributed DDL configuration -->
    <distributed_ddl>
        <path>/clickhouse/task_queue/ddl</path>
        <cleanup_delay_period>60</cleanup_delay_period>
        <task_max_lifetime>604800</task_max_lifetime>
    </distributed_ddl>
    
    <!-- Format schemas -->
    <format_schema_path>/var/lib/clickhouse/format_schemas/</format_schema_path>
</clickhouse>